


<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>syndat.exp_effects &#8212; Syndat 1.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/cloud.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Syndat 1.0.1 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">syndat.exp_effects</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for syndat.exp_effects</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Jun 23 10:34:17 2022</span>

<span class="sd">@author: noahwalton</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stat</span>


<span class="k">def</span> <span class="nf">t_to_e</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">rel</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="mf">939.56542052e6</span> <span class="c1"># eV/c2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span> <span class="c1"># m/s</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">mn</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="n">c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="mf">1.674927498e-27</span> <span class="c1">#kg</span>
        <span class="n">jev</span> <span class="o">=</span> <span class="mf">1.6022e-19</span> <span class="c1"># J/eV</span>
        <span class="n">E</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mn</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="n">jev</span> <span class="c1"># eV</span>
    <span class="k">return</span> <span class="n">E</span>


<span class="k">def</span> <span class="nf">e_to_t</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">rel</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="mf">939.56542052e6</span> <span class="c1"># eV/c2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">299792458</span> <span class="c1"># m/s</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="n">c</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">mn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jev</span> <span class="o">=</span> <span class="mf">1.6022e-19</span> <span class="c1"># J/eV</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="mf">1.674927498e-27</span> <span class="c1">#kg</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">jev</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="n">mn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<div class="viewcode-block" id="gaus_noise"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.gaus_noise">[docs]</a><span class="k">def</span> <span class="nf">gaus_noise</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">std_vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Samples gaussian noise around a vector of mean values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vector : array-like</span>
<span class="sd">        Vector of mean values.</span>
<span class="sd">    std_vec : array-like</span>
<span class="sd">        Vector of standard deviations (standard errors).</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Noisy vector sampled as guassian around each mean/std.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># scale (std) = sqrt(mean) resembles almost identically the poisson distribution with a number of counts&gt;20</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">std_vec</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span> <span class="c1">#np.mean(vector)*level</span>
    <span class="k">return</span> <span class="n">vector</span> <span class="o">+</span> <span class="n">noise</span></div>

<span class="c1"># def pois_noise(vector):</span>
<span class="c1">#     noise = []</span>
<span class="c1">#     for counts in vector:</span>
<span class="c1">#         noise.append(np.random.default_rng().poisson(lam=counts))</span>
<span class="c1">#     return vector + noise</span>
<div class="viewcode-block" id="pois_noise"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.pois_noise">[docs]</a><span class="k">def</span> <span class="nf">pois_noise</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Samples poissonian noise around a vector of values.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vector : array-like</span>
<span class="sd">        vector of expected values.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    noisy_vector</span>
<span class="sd">        Noisy vector sampled as poissonian around each expected value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">noisy_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">noisy_vector</span></div>

<div class="viewcode-block" id="generate_open_counts"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.generate_open_counts">[docs]</a><span class="k">def</span> <span class="nf">generate_open_counts</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">flux_mag</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate open (sample out) raw count data from a wide gaussian wrt energy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energy : array-like</span>
<span class="sd">        Array of energy values for each data point - corresponds to tof.</span>
<span class="sd">    flux_mag : float</span>
<span class="sd">        Magnitude scaling factor applied to flux shape, how many counts!</span>
<span class="sd">    mean : float</span>
<span class="sd">        Average value for gaussian shape.</span>
<span class="sd">    std : float</span>
<span class="sd">        Standard deviation for gaussian shape.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Open counts (sample out).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cts_o</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">std</span><span class="p">)</span><span class="o">*</span><span class="n">flux_mag</span> <span class="c1"># gaussian in energy, std=range of energy</span>
    <span class="k">return</span> <span class="n">cts_o</span></div>

<div class="viewcode-block" id="cts_to_ctr"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.cts_to_ctr">[docs]</a><span class="k">def</span> <span class="nf">cts_to_ctr</span><span class="p">(</span><span class="n">cts</span><span class="p">,</span> <span class="n">d_cts</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">trig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts counts to count rate and propagates uncertainty.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cts : array-like</span>
<span class="sd">        Array of count data corresponting to each tof bin.</span>
<span class="sd">    d_cts : array-like</span>
<span class="sd">        Array of uncertainty on each count data point corresponting to each tof bin.</span>
<span class="sd">    bw : array-like</span>
<span class="sd">        Array of tof bin widths.</span>
<span class="sd">    trig : float or int</span>
<span class="sd">        Number of linac pulses.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    _____</span>
<span class="sd">    Uncertainty propagation with sandwich rule (JxCxJ.T) is over 1000x slower. </span>
<span class="sd">    A more simple error propagtion is used because there is no covariance </span>
<span class="sd">    between the statistical variables.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ctr : array-like</span>
<span class="sd">        Array of count rates corresponding to each tof bin.</span>
<span class="sd">    d_nctr : array-like</span>
<span class="sd">        Array of propagated uncertainty on each count rate point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">ctr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cts</span><span class="o">/</span><span class="p">(</span><span class="n">bw</span><span class="o">*</span><span class="n">trig</span><span class="p">))</span>
    <span class="n">partial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">bw</span><span class="o">*</span><span class="n">trig</span><span class="p">))</span>
    <span class="n">d_nctr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">partial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_cts</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">d_nctr</span></div>

    

<div class="viewcode-block" id="generate_raw_count_data"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.generate_raw_count_data">[docs]</a><span class="k">def</span> <span class="nf">generate_raw_count_data</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">open_df</span><span class="p">,</span> <span class="n">add_noise</span><span class="p">,</span> <span class="n">trigo</span><span class="p">,</span><span class="n">trigs</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">K</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span><span class="n">B0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates raw count data for sample-in given a theoretical tranmission. </span>
<span class="sd">    </span>
<span class="sd">    This function performs the inverse of the reduction process, calculating raw count data</span>
<span class="sd">    from a theoretical transmission. This process requires the assumption of known,</span>
<span class="sd">    true underlying reduction parameters and open count data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sample_df : pandas.DataFrame</span>
<span class="sd">        Sample in dataframe with a column for theoretical tranmission [&#39;theo_trans&#39;] and energy [&#39;E&#39;].</span>
<span class="sd">    open_df : pandas.DataFrame</span>
<span class="sd">        Open dataframe, columns [&#39;E&#39;], [&#39;bw&#39;]</span>
<span class="sd">    trigo : int</span>
<span class="sd">        Number of times the LINAC is fired for the open counts, corresponding to the number of times each channel is openned for counts.</span>
<span class="sd">    trigs : int</span>
<span class="sd">        Number of times the LINAC is fired for the sample-in counts, corresponding to the number of times each channel is openned for counts.</span>
<span class="sd">    k : float</span>
<span class="sd">        Background normalization for sample in.</span>
<span class="sd">    K : float</span>
<span class="sd">        Background normalization for sample out.</span>
<span class="sd">    Bi : array-like</span>
<span class="sd">        Background shape function stored as a vector.</span>
<span class="sd">    b0 : float</span>
<span class="sd">        Constant background for sample in.</span>
<span class="sd">    B0 : float</span>
<span class="sd">        Constant background for sample out.</span>
<span class="sd">    alpha : array-like</span>
<span class="sd">        Vector of monitor stability factors [m1,m2,m3,m4]</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sample_df : pandas.DataFrame</span>
<span class="sd">        Dataframe containing data for sample in.</span>
<span class="sd">    open_df : pandas.DataFrame</span>
<span class="sd">        Dataframe containing data for sample out.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate open count rates</span>
    <span class="n">Cr</span><span class="p">,</span> <span class="n">dCr</span> <span class="o">=</span> <span class="n">cts_to_ctr</span><span class="p">(</span><span class="n">open_df</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">open_df</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">open_df</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">trigo</span><span class="p">)</span> <span class="c1"># cts_o/(bw*trig)</span>
    <span class="n">open_df</span><span class="p">[</span><span class="s1">&#39;cps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cr</span><span class="p">;</span> <span class="n">open_df</span><span class="p">[</span><span class="s1">&#39;dcps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dCr</span>
    
    <span class="c1"># calculate sample in count rate from theoretical transmission, bkg, m,k, and open count rate</span>
    <span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">m3</span><span class="p">,</span><span class="n">m4</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">theo_trans</span><span class="o">*</span><span class="p">(</span><span class="n">m3</span><span class="o">*</span><span class="n">Cr</span> <span class="o">-</span> <span class="n">m4</span><span class="o">*</span><span class="n">K</span><span class="o">*</span><span class="n">Bi</span> <span class="o">-</span> <span class="n">B0</span><span class="p">)</span> <span class="o">+</span> <span class="n">m2</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">Bi</span> <span class="o">+</span> <span class="n">b0</span><span class="p">)</span><span class="o">/</span><span class="n">m1</span>
    
    <span class="c1"># calculate sample in counts from count rate</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cr</span><span class="o">*</span><span class="n">open_df</span><span class="o">.</span><span class="n">bw</span><span class="o">*</span><span class="n">trigs</span>

    <span class="c1"># correct for dead time</span>
    <span class="c1"># c = c*</span>


    <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;theo_cts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
    <span class="c1"># c = np.where(c&lt;0, float(10), c) uneccessary, no negatives</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_noise</span><span class="p">:</span>
        <span class="c1"># c = gaus_noise(c, np.sqrt(c))</span>
        <span class="c1"># c = np.where(c&lt;1, float(10), c)</span>
        <span class="c1"># dc = np.sqrt(c)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pois_noise</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
    <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;dc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span>

    <span class="k">return</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">open_df</span></div>





<div class="viewcode-block" id="get_covT"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.get_covT">[docs]</a><span class="k">def</span> <span class="nf">get_covT</span><span class="p">(</span><span class="n">tof</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span><span class="n">C</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span><span class="n">dC</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">K</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span><span class="n">B0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sys_unc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the output covariance matrix of transmission from input uncertainties.</span>

<span class="sd">    This function uses the covariance sandwhich rule:</span>
<span class="sd">    .. math:: C_y = J^T*C_x*J</span>
<span class="sd">    to propagate input variance-covariance to transmission data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tof : array-like</span>
<span class="sd">        Array of time of flight values for each data point - corresponds to energy.</span>
<span class="sd">    c : float</span>
<span class="sd">        Count rate for sample in.</span>
<span class="sd">    C : float</span>
<span class="sd">        Count rate for sample out.</span>
<span class="sd">    dc : float</span>
<span class="sd">        Uncertainty in the count rate for sample-in.</span>
<span class="sd">    dC : array-like</span>
<span class="sd">        Uncertainty in the count rate for sample-out.</span>
<span class="sd">    a : float</span>
<span class="sd">        Shaping parameter for exponential background function.</span>
<span class="sd">    b : float</span>
<span class="sd">        Shaping parameter for exponential background function.</span>
<span class="sd">    k : float</span>
<span class="sd">        Background normalization for sample in.</span>
<span class="sd">    K : float</span>
<span class="sd">        Background normalization for sample out.</span>
<span class="sd">    Bi : array-like</span>
<span class="sd">        Background shape function stored as a vector.</span>
<span class="sd">    b0 : float</span>
<span class="sd">        Constant background for sample in.</span>
<span class="sd">    B0 : float</span>
<span class="sd">        Constant background for sample out.</span>
<span class="sd">    alpha : array-like</span>
<span class="sd">        Vector of monitor stability factors [m1,m2,m3,m4]</span>
<span class="sd">    sys_unc : array-like</span>
<span class="sd">        Vector of systematic uncertainties: [da,db,dk_i,dk_o,dB0_i,dB0_o,m1,m2,m3,m4].</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Background function must be of form Bi = a*exp(-b). Explicitly coded derivatives for Jacobian.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Output covaraiance matrix for transmission.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># cast all into numpy arrays</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">);</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">C</span><span class="p">);</span> <span class="n">dC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dC</span><span class="p">)</span>
    <span class="n">tof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tof</span><span class="p">)</span>
    <span class="n">Bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Bi</span><span class="p">)</span>
    <span class="n">sys_unc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sys_unc</span><span class="p">)</span>

    <span class="c1"># derivatives</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">C</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">K</span><span class="o">*</span><span class="n">Bi</span> <span class="o">-</span> <span class="n">B0</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">Bi</span> <span class="o">-</span> <span class="n">b0</span>
    
    <span class="c1"># construct statistical covariance and jacobian</span>
    <span class="n">dTi_dci</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">D</span>
    <span class="n">dTi_dCi</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">dc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dTi_dci</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dC</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dTi_dCi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">CovT_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>

    <span class="c1"># construct systematic covariance and jacobian</span>
    <span class="n">Cov_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sys_unc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># print(&quot;WARNING: Need to update getCov function to take a/b covariances, currently it says cov = var*var&quot;)</span>
    <span class="n">Cov_sys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.42659922e-1</span> <span class="c1"># 1.42405866e-01 # sys_unc[0]*sys_unc[1]  </span>
    <span class="n">Cov_sys</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.42659922e-1</span> <span class="c1"># 1.42405866e-01 #sys_unc[1]*sys_unc[0]        </span>
    
    <span class="c1"># systematic derivatives</span>
    <span class="n">dTi_da</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">K</span><span class="o">*</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1">#   -(k*alpha[1]*D+K*alpha[3]*N)*np.exp(-b*tof) / (D**2)</span>
    <span class="n">dTi_db</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">K</span><span class="o">*</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">Bi</span><span class="o">*</span><span class="n">tof</span><span class="o">/</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span>  <span class="c1">#   (k*alpha[1]*D)*Bi*tof / (D**2)</span>
    <span class="n">dTi_dk</span> <span class="o">=</span> <span class="o">-</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Bi</span><span class="o">/</span><span class="n">D</span>         <span class="c1">#   D**2</span>
    <span class="n">dTi_dK</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">Bi</span><span class="o">/</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">dTi_db0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">D</span>
    <span class="n">dTi_dB0</span> <span class="o">=</span> <span class="n">N</span><span class="o">/</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">dTi_dalpha</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span><span class="o">/</span><span class="n">D</span><span class="p">,</span> <span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">Bi</span><span class="o">/</span><span class="n">D</span><span class="p">,</span> <span class="o">-</span><span class="n">C</span><span class="o">*</span><span class="n">N</span><span class="o">/</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">K</span><span class="o">*</span><span class="n">Bi</span><span class="o">*</span><span class="n">N</span><span class="o">/</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span> <span class="p">]</span>
    
    <span class="n">Jac_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dTi_da</span><span class="p">,</span> <span class="n">dTi_db</span><span class="p">,</span> <span class="n">dTi_dk</span><span class="p">,</span> <span class="n">dTi_dK</span><span class="p">,</span> <span class="n">dTi_db0</span><span class="p">,</span> <span class="n">dTi_dB0</span><span class="p">,</span> <span class="n">dTi_dalpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dTi_dalpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dTi_dalpha</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">dTi_dalpha</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
    
                
    <span class="c1"># calculate covariance of output</span>
    <span class="n">CovT_sys</span> <span class="o">=</span> <span class="n">Jac_sys</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Cov_sys</span> <span class="o">@</span> <span class="n">Jac_sys</span>
    
    <span class="n">CovT</span> <span class="o">=</span> <span class="n">CovT_stat</span> <span class="o">+</span> <span class="n">CovT_sys</span>
    
    <span class="k">return</span> <span class="n">CovT</span><span class="p">,</span> <span class="n">CovT_stat</span><span class="p">,</span> <span class="n">CovT_sys</span></div>



<span class="k">def</span> <span class="nf">transmission</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="n">Cr</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">K</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span><span class="n">B0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="p">[</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">m3</span><span class="p">,</span><span class="n">m4</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">m1</span><span class="o">*</span><span class="n">cr</span> <span class="o">-</span> <span class="n">m2</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">Bi</span> <span class="o">-</span> <span class="n">b0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m3</span><span class="o">*</span><span class="n">Cr</span> <span class="o">-</span> <span class="n">m4</span><span class="o">*</span><span class="n">K</span><span class="o">*</span><span class="n">Bi</span> <span class="o">-</span> <span class="n">B0</span><span class="p">)</span> 

    
<div class="viewcode-block" id="reduce_raw_count_data"><a class="viewcode-back" href="../../source_api/exp_effects.html#syndat.exp_effects.reduce_raw_count_data">[docs]</a><span class="k">def</span> <span class="nf">reduce_raw_count_data</span><span class="p">(</span><span class="n">tof</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span><span class="n">C</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span><span class="n">dC</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">trigo</span><span class="p">,</span><span class="n">trigs</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">K</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span><span class="n">B0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sys_unc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduces raw count data to transmission data with propagated uncertainty.</span>

<span class="sd">    This function uses the covariance sandwhich rule:</span>
<span class="sd">    .. math:: C_y = J^T*C_x*J</span>
<span class="sd">    to propagate input variance-covariance from both statistical uncertainties</span>
<span class="sd">    and systematic uncertainties to transmission data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tof : array-like</span>
<span class="sd">        Array of time of flight values for each data point - corresponds to energy.</span>
<span class="sd">    c : float</span>
<span class="sd">        Count rate for sample in.</span>
<span class="sd">    C : float</span>
<span class="sd">        Count rate for sample out.</span>
<span class="sd">    dc : float</span>
<span class="sd">        Uncertainty in the count rate for sample-in.</span>
<span class="sd">    dC : array-like</span>
<span class="sd">        Uncertainty in the count rate for sample-out.</span>
<span class="sd">    bw : float</span>
<span class="sd">        Width in time a given channel is open, bin width.</span>
<span class="sd">    trig : int</span>
<span class="sd">        Number of times the LINAC is fired, corresponding to the number of times each channel is openned for counts.</span>
<span class="sd">    a : float</span>
<span class="sd">        Shaping parameter for exponential background function.</span>
<span class="sd">    b : float</span>
<span class="sd">        Shaping parameter for exponential background function.</span>
<span class="sd">    k : float</span>
<span class="sd">        Background normalization for sample in.</span>
<span class="sd">    K : float</span>
<span class="sd">        Background normalization for sample out.</span>
<span class="sd">    Bi : array-like</span>
<span class="sd">        Background shape function stored as a vector.</span>
<span class="sd">    b0 : float</span>
<span class="sd">        Constant background for sample in.</span>
<span class="sd">    B0 : float</span>
<span class="sd">        Constant background for sample out.</span>
<span class="sd">    alpha : array-like</span>
<span class="sd">        Vector of monitor stability factors [m1,m2,m3,m4]</span>
<span class="sd">    sys_unc : array-like</span>
<span class="sd">        Vector of systematic uncertainties: [da,db,dk_i,dk_o,dB0_i,dB0_o,m1,m2,m3,m4].</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Background function must be of form Bi = a*exp(-b)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Output covaraiance matrix for transmission.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate count rate and propagate uncertainty</span>
    <span class="n">Cr</span><span class="p">,</span> <span class="n">dCr</span> <span class="o">=</span> <span class="n">cts_to_ctr</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">dC</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">trigo</span><span class="p">)</span> 
    <span class="n">cr</span><span class="p">,</span> <span class="n">dcr</span> <span class="o">=</span> <span class="n">cts_to_ctr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">trigs</span><span class="p">)</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="n">Cr</span><span class="p">,</span><span class="n">dCr</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span><span class="n">dcr</span>
    
    <span class="c1"># calculate transmission</span>
    <span class="n">Tn</span> <span class="o">=</span> <span class="n">transmission</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="n">Cr</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">K</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span><span class="n">B0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="c1"># propagate uncertainty to transmission</span>
    <span class="n">CovT</span><span class="p">,</span> <span class="n">CovT_stat</span><span class="p">,</span> <span class="n">CovT_sys</span> <span class="o">=</span> <span class="n">get_covT</span><span class="p">(</span><span class="n">tof</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span><span class="n">Cr</span><span class="p">,</span> <span class="n">dcr</span><span class="p">,</span><span class="n">dCr</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">K</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span><span class="n">B0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sys_unc</span><span class="p">)</span>
    <span class="n">dT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">CovT</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">Tn</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">CovT</span><span class="p">,</span> <span class="n">CovT_stat</span><span class="p">,</span> <span class="n">CovT_sys</span><span class="p">,</span> <span class="n">rates</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Syndat 1.0.1 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">syndat.exp_effects</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Walton.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>